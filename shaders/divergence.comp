#version 430 core

layout(local_size_x = 16, local_size_y = 16) in;

layout(rg32f, binding = 0) readonly uniform image2D velocity;
layout(r32f, binding = 1) writeonly uniform image2D divergence;

uniform vec2 texelSize;

void main() {
    ivec2 pos = ivec2(gl_GlobalInvocationID.xy);
    ivec2 size = imageSize(velocity);

    if (pos.x >= size.x || pos.y >= size.y) return;

    // Sample current and right/top velocities (forward difference for consistency with Laplacian)
    vec2 vC = imageLoad(velocity, pos).xy;
    float uR = (pos.x < size.x - 1) ? imageLoad(velocity, pos + ivec2(1, 0)).x : 0.0;
    float vT = (pos.y < size.y - 1) ? imageLoad(velocity, pos + ivec2(0, 1)).y : 0.0;

    // Compute divergence using forward differences: div = (u[i+1] - u[i]) + (v[j+1] - v[j])
    float div = (uR - vC.x) + (vT - vC.y);

    imageStore(divergence, pos, vec4(div, 0.0, 0.0, 0.0));
}
