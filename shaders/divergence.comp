#version 430 core

layout(local_size_x = 16, local_size_y = 16) in;

layout(r32f, binding = 0) readonly uniform image2D uVelocity;
layout(r32f, binding = 1) readonly uniform image2D vVelocity;
layout(r32f, binding = 2) writeonly uniform image2D divergence;

void main() {
    ivec2 pos = ivec2(gl_GlobalInvocationID.xy);
    ivec2 size = imageSize(uVelocity);

    if (pos.x >= size.x || pos.y >= size.y) return;

    // Sample current and right/top velocities (forward difference for consistency with Laplacian)
    float uC = imageLoad(uVelocity, pos).r;
    float vC = imageLoad(vVelocity, pos).r;
    float uR = (pos.x < size.x - 1) ? imageLoad(uVelocity, pos + ivec2(1, 0)).r : 0.0;
    float vT = (pos.y < size.y - 1) ? imageLoad(vVelocity, pos + ivec2(0, 1)).r : 0.0;

    // Compute divergence using forward differences: div = (u[i+1] - u[i]) + (v[j+1] - v[j])
    float div = (uR - uC) + (vT - vC);

    imageStore(divergence, pos, vec4(div, 0.0, 0.0, 0.0));
}
