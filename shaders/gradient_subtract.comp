#version 430 core

layout(local_size_x = 16, local_size_y = 16) in;

layout(r32f, binding = 0) readonly uniform image2D pressure;
layout(r32f, binding = 1) readonly uniform image2D uVelocityIn;
layout(r32f, binding = 2) readonly uniform image2D vVelocityIn;
layout(r32f, binding = 3) writeonly uniform image2D uVelocityOut;
layout(r32f, binding = 4) writeonly uniform image2D vVelocityOut;

void main() {
    ivec2 pos = ivec2(gl_GlobalInvocationID.xy);
    ivec2 size = imageSize(pressure);

    if (pos.x >= size.x || pos.y >= size.y) return;

    // Sample current and left/bottom pressures (backward difference for consistency with Laplacian)
    float pC = imageLoad(pressure, pos).r;
    float pL = (pos.x > 0) ? imageLoad(pressure, pos - ivec2(1, 0)).r : pC;
    float pB = (pos.y > 0) ? imageLoad(pressure, pos - ivec2(0, 1)).r : pC;

    // Compute pressure gradient using backward differences: grad = (p[i] - p[i-1], p[j] - p[j-1])
    float gradX = pC - pL;
    float gradY = pC - pB;

    // Subtract gradient from velocity to make it divergence-free
    float u = imageLoad(uVelocityIn, pos).r;
    float v = imageLoad(vVelocityIn, pos).r;
    u -= gradX;
    v -= gradY;

    // Free-slip boundary conditions: zero normal velocity at walls
    if (pos.x == 0 || pos.x == size.x - 1) u = 0.0;
    if (pos.y == 0 || pos.y == size.y - 1) v = 0.0;

    imageStore(uVelocityOut, pos, vec4(u, 0.0, 0.0, 0.0));
    imageStore(vVelocityOut, pos, vec4(v, 0.0, 0.0, 0.0));
}
