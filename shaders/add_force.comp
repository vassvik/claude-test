#version 430 core

layout(local_size_x = 16, local_size_y = 16) in;

layout(rg32f, binding = 0) uniform image2D velocity;
layout(rgba32f, binding = 1) uniform image2D density;

uniform vec2 point;      // Position of force application (0-1)
uniform vec2 force;      // Force direction and magnitude (grid cells/sec)
uniform float radius;    // Radius of influence (in UV space)
uniform vec3 dyeColor;   // Color to inject

void main() {
    ivec2 pos = ivec2(gl_GlobalInvocationID.xy);
    ivec2 size = imageSize(velocity);

    if (pos.x >= size.x || pos.y >= size.y) return;

    vec2 uv = (vec2(pos) + 0.5) / vec2(size);

    // Distance from mouse position
    vec2 diff = uv - point;
    float dist = length(diff);

    // Gaussian splat
    float influence = exp(-dist * dist / (radius * radius));

    // Add force to velocity (velocity in grid cells/sec)
    vec2 vel = imageLoad(velocity, pos).xy;
    vel += force * influence;
    imageStore(velocity, pos, vec4(vel, 0.0, 0.0));

    // Add dye to density
    vec4 dye = imageLoad(density, pos);
    dye.rgb += dyeColor * influence;
    imageStore(density, pos, dye);
}
