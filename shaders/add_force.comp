#version 430 core

layout(local_size_x = 16, local_size_y = 16) in;

layout(r32f, binding = 0) uniform image2D uVelocity;
layout(r32f, binding = 1) uniform image2D vVelocity;
layout(rgba32f, binding = 2) uniform image2D density;

uniform vec2 point;      // Position of force application (0-1)
uniform vec2 force;      // Force direction and magnitude (grid cells/sec)
uniform float radius;    // Radius of influence (in UV space)
uniform vec3 dyeColor;   // Color to inject

void main() {
    ivec2 pos = ivec2(gl_GlobalInvocationID.xy);
    ivec2 size = imageSize(uVelocity);

    if (pos.x >= size.x || pos.y >= size.y) return;

    // MAC grid positions:
    // u lives at left face (i, j+0.5), v lives at bottom face (i+0.5, j)
    // density lives at cell center (i+0.5, j+0.5)
    vec2 uv_u = vec2(float(pos.x), float(pos.y) + 0.5) / vec2(size);
    vec2 uv_v = vec2(float(pos.x) + 0.5, float(pos.y)) / vec2(size);
    vec2 uv_density = (vec2(pos) + 0.5) / vec2(size);

    // Compute separate influences for each staggered location
    float dist_u = length(uv_u - point);
    float dist_v = length(uv_v - point);
    float dist_density = length(uv_density - point);

    float influence_u = exp(-dist_u * dist_u / (radius * radius));
    float influence_v = exp(-dist_v * dist_v / (radius * radius));
    float influence_density = exp(-dist_density * dist_density / (radius * radius));

    // Add force to velocity at respective face locations
    float u = imageLoad(uVelocity, pos).r;
    float v = imageLoad(vVelocity, pos).r;
    u += force.x * influence_u;
    v += force.y * influence_v;
    imageStore(uVelocity, pos, vec4(u, 0.0, 0.0, 0.0));
    imageStore(vVelocity, pos, vec4(v, 0.0, 0.0, 0.0));

    // Add dye to density at cell center
    vec4 dye = imageLoad(density, pos);
    dye.rgb += dyeColor * influence_density;
    imageStore(density, pos, dye);
}
