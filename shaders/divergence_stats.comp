#version 430 core
layout(local_size_x = 16, local_size_y = 16) in;

layout(r32f, binding = 0) readonly uniform image2D preDivergence;
layout(r32f, binding = 1) readonly uniform image2D postDivergence;

layout(std430, binding = 0) buffer StatsBuffer {
    uint histogram[32 * 32];  // [postBin * 32 + preBin]
};

int getBin(float div) {
    float absDiv = abs(div);
    return clamp(int(log2(absDiv)) + 24, 0, 31);
}

void main() {
    ivec2 pos = ivec2(gl_GlobalInvocationID.xy);
    ivec2 size = imageSize(preDivergence);
    if (pos.x >= size.x || pos.y >= size.y) return;

    float preDiv = imageLoad(preDivergence, pos).r;
    float postDiv = imageLoad(postDivergence, pos).r;

    int preBin = getBin(preDiv);
    int postBin = getBin(postDiv);

    atomicAdd(histogram[postBin * 32 + preBin], 1u);
}
