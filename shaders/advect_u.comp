#version 430 core

layout(local_size_x = 16, local_size_y = 16) in;

// u-velocity grid: 513x512 (one extra column for vertical faces)
layout(r32f, binding = 0) writeonly uniform image2D uVelocityOut;

uniform sampler2D uVelocitySampler;  // 513x512
uniform sampler2D vVelocitySampler;  // 512x513
uniform float dt;
uniform float dissipation;

// Grid dimensions
uniform ivec2 uSize;  // 513x512
uniform ivec2 vSize;  // 512x513

// Sample u-velocity at world position (wx, wy)
// u[i,j] is stored at texel [i,j] and represents velocity at world pos (i, j+0.5)
float sampleU(vec2 worldPos) {
    // To sample at world pos (wx, wy):
    // texel [i,j] has center at UV = ((i+0.5)/width, (j+0.5)/height)
    // worldPos (wx, wy) corresponds to texel (wx, wy-0.5)
    // UV = ((wx + 0.5)/width, ((wy-0.5) + 0.5)/height) = ((wx+0.5)/width, wy/height)
    vec2 uv = vec2((worldPos.x + 0.5) / float(uSize.x), worldPos.y / float(uSize.y));
    return texture(uVelocitySampler, uv).r;
}

// Sample v-velocity at world position (wx, wy)
// v[i,j] is stored at texel [i,j] and represents velocity at world pos (i+0.5, j)
float sampleV(vec2 worldPos) {
    // To sample at world pos (wx, wy):
    // texel [i,j] has center at UV = ((i+0.5)/width, (j+0.5)/height)
    // worldPos (wx, wy) corresponds to texel (wx-0.5, wy)
    // UV = ((wx-0.5+0.5)/width, (wy+0.5)/height) = (wx/width, (wy+0.5)/height)
    vec2 uv = vec2(worldPos.x / float(vSize.x), (worldPos.y + 0.5) / float(vSize.y));
    return texture(vVelocitySampler, uv).r;
}

void main() {
    ivec2 pos = ivec2(gl_GlobalInvocationID.xy);

    if (pos.x >= uSize.x || pos.y >= uSize.y) return;

    // u[pos.x, pos.y] lives at world position (pos.x, pos.y + 0.5)
    vec2 worldPos = vec2(float(pos.x), float(pos.y) + 0.5);

    // Sample velocity at this position
    float u_here = sampleU(worldPos);
    float v_here = sampleV(worldPos);
    vec2 vel = vec2(u_here, v_here);

    // Trace back in time (velocity is in grid cells/sec)
    vec2 prevWorldPos = worldPos - vel * dt;

    // Sample u at previous position
    float new_u = sampleU(prevWorldPos);

    // Apply dissipation
    new_u *= dissipation;

    imageStore(uVelocityOut, pos, vec4(new_u, 0.0, 0.0, 0.0));
}
